from threading import Event
from time import sleep
import time

from ..client import Client

def print_status(client, timeout_sec=120):
    output = ""
    timeout = time.time() + timeout_sec
    while not client.get_stdout_queue().empty() or time.time() < timeout:
        sleep(5)
        if not client.get_stdout_queue().empty():
            msg = client.get_stdout_queue().get()
            if msg != '_EOF_':
                if 'END' == msg:
                    #print(f'##: {client.get_stdout_queue().qsize()}')
                    while not client.get_stdout_queue().empty():
                        client.get_stdout_queue().get()
                    #print(f'##: {client.get_stdout_queue().qsize()}')
                    return
                output += msg    
                timeout = time.time() + timeout_sec
            else:
                #print(f'-: {client.get_stdout_queue().qsize()}')
                print(output)
                msg = ""
                output = "" 
    print("Open CMD Input...") 
    return 

def cmd(client, timeout_sec=30):
    cmd = ''    
    while cmd != 'exit':
        output = ">> "
        msg = ''
        timeout = time.time() + timeout_sec
        while client.get_stdout_queue().qsize() != 0 or time.time() < timeout:
            sleep(0.1)
            if client.get_stdout_queue().qsize() != 0:
                #print(f'Get Packet QS: {client.get_stdout_queue().qsize()}')
                msg = client.get_stdout_queue().get()
                if msg != '_EOF_':
                    output += msg      
                    timeout = time.time() + timeout_sec
                else:
                    break
        print(output)
        cmd = input('$ ')
        if cmd:
            client.get_stdin_queue().put(cmd) # send cmd
            
def shell_main(clients, client_list_lock, shutdown_signal: Event):
    while True:
        sleep(2)
        if shutdown_signal.is_set():
            return
        for name,client in clients.items():
            print("Use Target: "+name)
            print_status(client)
            cmd(client)
        
