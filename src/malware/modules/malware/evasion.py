import logging
import os
import sys
import inspect

def is_vm():
    return any([detect_vm_linux_through_dev_disk_by_id(), detect_vm_linux_through_system_detect_virt()])

def detect_vm_linux_through_dev_disk_by_id():
    """
    detect virtualization through (internal or external) disks that are connected to the system under /dev/disk/by-id
    https://wiki.tcl-lang.org/page/%2Fdev%2Fdisk#:~:text=On%20Linux%20systems%2C%20%2Fdev%2F,in%20more%20user%2Dfriendly%20names.
    https://unix.stackexchange.com/questions/89714/easy-way-to-determine-the-virtualization-technology-of-a-linux-machine
    """
    vms = ['vbox', 'qemu']
    cmd = "ls -l /dev/disk/by-id/ | awk '{ print $9 }' "
    output = os.popen(cmd).read().lower().split('\n')
    for line in output:
        for vm in vms:
            if vm in line:
                logging.info(f"Found virtualization: {vm}")
                return True
    logging.info(f"Found no virtualization")
    return False

def detect_vm_linux_through_system_detect_virt():
    """
    Linux command to detect virtual machine e.g. VirtualBox
    ------------------------------
    $ > systemd-detect-virt      |
    oracle                       |
    ------------------------------
    https://unix.stackexchange.com/questions/89714/easy-way-to-determine-the-virtualization-technology-of-a-linux-machine
    https://www.freedesktop.org/software/systemd/man/systemd-detect-virt.html

    """
    vms = ["qemu", "kvm", "amazon", "zvm", "vmware", "microsoft", "oracle", "powervm", "xen", "bochs", "uml", "parrallels", "bhyve", "qnx", "acrn"]
    cmd = "systemd-detect-virt"
    output = os.popen(cmd).read().replace('\n', '')
    if output in vms:
        logging.info(f"Found virtualization: {output}")
        return True
    logging.info(f"Found no virtualization")
    return False

def is_debugger():
    return any([detect_debugger_gettrace(), detect_debugger_hasattr(), detect_debugger_stack()])

def detect_debugger_gettrace():
    # https://stackoverflow.com/questions/38634988/check-if-program-runs-in-debug-mode
    # https://www.adamsmith.haus/python/answers/how-to-determine-if-code-is-being-run-inside-a-virtual-machine-in-python
    # -> https://virtualenv.pypa.io/en/16.7.9/reference.html
    if sys.gettrace():
        logging.info(f"Found debugger")
        return True
    logging.info(f"Found no debugger")
    return False

def detect_debugger_hasattr():
    """
    https://stackoverflow.com/questions/1871549/determine-if-python-is-running-inside-virtualenv
    """
    if hasattr(sys, 'real_prefix'):            
        logging.info(f"Found virtual env")
        return True
    logging.info(f"Found no virtual env")
    return False

def detect_debugger_stack():
    # https://stackoverflow.com/questions/333995/how-to-detect-that-python-code-is-being-executed-through-the-debugger
    debuggers = ("pydevd", "pdb")
    for frame in inspect.stack():
        for debugger in debuggers:
            if debugger in frame[1]:
                logging.info(f"Found debugger: {debugger}")
                return True
    logging.info(f"Found no debugger")
    return False



if __name__ == '__main__':
    FORMAT = '[%(asctime)s] [%(funcName)-30s] [%(levelname)-8s] [%(message)s]'
    logging.basicConfig(filename='malware.log', encoding='utf-8', format=FORMAT, level=0)
    logging.basicConfig(stream=sys.stdout, format=FORMAT, level=0)

    print(f"is vm: {is_vm()}")
    print(f"is debugger: {is_debugger()}")   
